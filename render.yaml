databases:
  - name: ppm-db
    plan: free
    databaseName: ppm_db
    user: ppm_user

services:
  - type: redis
    name: ppm-redis
    plan: free
    maxmemoryPolicy: noeviction

  - type: web
    name: ppm-api
    env: node
    plan: free
    rootDir: backend
    buildCommand: npm ci --include=dev && npm run prisma:generate && npm run build
    startCommand: ./node_modules/.bin/prisma db push && node dist/main
    envVars:
      - key: NODE_ENV
        value: production
      - key: APP_PORT
        value: 3001
      - key: DATABASE_URL
        fromDatabase:
          name: ppm-db
          property: connectionString
      - key: REDIS_URL
        sync: false
      - key: FRONTEND_URL
        value: https://ppm-web.onrender.com
      - key: CORS_ORIGINS
        value: https://ppm-web.onrender.com
      - key: JWT_ACCESS_SECRET
        generateValue: true
      - key: JWT_REFRESH_SECRET
        generateValue: true
      - key: JWT_ACCESS_EXPIRY
        value: 15m
      - key: JWT_REFRESH_EXPIRY
        value: 7d
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: ANTHROPIC_MODEL
        value: claude-sonnet-4-6
      - key: ANTHROPIC_MAX_TOKENS
        value: "4096"
      - key: MINIO_ENDPOINT
        value: localhost
      - key: MINIO_PORT
        value: "9000"
      - key: MINIO_USE_SSL
        value: "false"
      - key: MINIO_ACCESS_KEY
        value: minioadmin
      - key: MINIO_SECRET_KEY
        value: minioadmin
      - key: MINIO_BUCKET_NAME
        value: ppm-documents
      - key: THROTTLE_TTL
        value: "60"
      - key: THROTTLE_LIMIT
        value: "100"
      - key: LOG_LEVEL
        value: info

  - type: web
    name: ppm-web
    env: node
    plan: free
    rootDir: frontend
    buildCommand: npm ci && npm run build
    startCommand: npm run start
    envVars:
      - key: NEXT_PUBLIC_API_URL
        value: https://ppm-api.onrender.com
      - key: NEXT_PUBLIC_APP_NAME
        value: AI PPM Platform
      - key: NEXT_PUBLIC_APP_VERSION
        value: "1.0.0"
